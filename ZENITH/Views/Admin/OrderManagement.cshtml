@model List<ZENITH.Models.Order>
@{
    ViewData["Title"] = " Order Management";
    ViewData["Admin"] = "OrderManagement"; 
    Layout = "~/Views/Shared/_LayoutAdmin.cshtml";
}
<div class="container-fluid">
    <form method="get" class="mb-3">
        <div class="form-row" style="display:flex;gap:12px;flex-wrap:wrap">
            <input type="text" name="query" value="@((string)ViewBag.Query ?? "")" class="form-control" placeholder="Tìm theo mã đơn, tên hoặc email" style="max-width:320px" />
            <select name="status" class="form-control" style="max-width:220px">
                <option value="">Tất cả trạng thái</option>
                @foreach (var s in (IEnumerable<string>)ViewBag.Statuses)
                {
                    if ((string)ViewBag.SelectedStatus == s)
                    {
                        <option value="@s" selected="selected">@s</option>
                    }
                    else
                    {
                        <option value="@s">@s</option>
                    }
                }
            </select>
            <button class="btn btn-primary" type="submit">Lọc</button>
        </div>
    </form>

    <div class="card">
        <div class="card-header border-0"><h3 class="card-title">Danh sách đơn hàng</h3></div>
        <div class="card-body table-responsive p-0">
            <table class="table table-striped table-valign-middle">
                <thead>
                    <tr>
                        <th>Mã đơn</th>
                        <th>Khách hàng</th>
                        <th>Tổng tiền</th>
                        <th>Thanh toán</th>
                        <th>Trạng thái</th>
                        <th>Địa chỉ giao hàng</th>
                        <th>Ngày tạo</th>
                        <th>Thao tác</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var o in Model)
                    {
                        <tr>
                            <td>@o.OrderCode</td>
                            <td>@o.User.FullName</td>
                            <td>@o.TotalAmount.ToString("N0", new System.Globalization.CultureInfo("vi-VN")) VND</td>
                            <td>
                                <form asp-controller="Admin" asp-action="UpdatePaymentStatus" method="post" style="display:flex;gap:8px;align-items:center">
                                    @Html.AntiForgeryToken()
                                    <input type="hidden" name="orderId" value="@o.OrderId" />
                                    <input type="hidden" name="filterStatus" value="@((string)ViewBag.SelectedStatus ?? "")" />
                                    <input type="hidden" name="query" value="@((string)ViewBag.Query ?? "")" />
                                    <select class="form-control" name="status" style="max-width:200px">
                                        @if (o.PaymentStatus=="Pending") {<option value="Pending" selected="selected">Đang chờ</option>} else {<option value="Pending">Đang chờ</option>}
                                        @if (o.PaymentStatus=="Paid") {<option value="Paid" selected="selected">Đã thanh toán</option>} else {<option value="Paid">Đã thanh toán</option>}
                                        @if (o.PaymentStatus=="Failed") {<option value="Failed" selected="selected">Thất bại</option>} else {<option value="Failed">Thất bại</option>}
                                        @if (o.PaymentStatus=="Refunded") {<option value="Refunded" selected="selected">Hoàn tiền</option>} else {<option value="Refunded">Hoàn tiền</option>}
                                    </select>
                                    <button class="btn btn-sm btn-outline-primary" type="submit">Cập nhật</button>
                                </form>
                            </td>
                            <td>
                                <form asp-controller="Admin" asp-action="UpdateOrderStatus" method="post" style="display:flex;gap:8px;align-items:center">
                                    @Html.AntiForgeryToken()
                                    <input type="hidden" name="orderId" value="@o.OrderId" />
                                    <select class="form-control" name="status" style="max-width:220px">
                                        @if (o.OrderStatus == "Chờ xác nhận")
                                        {
                                            <option value="Chờ xác nhận" selected="selected">Chờ xác nhận</option>
                                        }
                                        else
                                        {
                                            <option value="Chờ xác nhận">Chờ xác nhận</option>
                                        }
                                        @if (o.OrderStatus == "Vận chuyển")
                                        {
                                            <option value="Vận chuyển" selected="selected">Vận chuyển</option>
                                        }
                                        else
                                        {
                                            <option value="Vận chuyển">Vận chuyển</option>
                                        }
                                        @if (o.OrderStatus == "Chờ Giao Hàng")
                                        {
                                            <option value="Chờ Giao Hàng" selected="selected">Chờ Giao Hàng</option>
                                        }
                                        else
                                        {
                                            <option value="Chờ Giao Hàng">Chờ Giao Hàng</option>
                                        }
                                        @if (o.OrderStatus == "Hoàn Thành")
                                        {
                                            <option value="Hoàn Thành" selected="selected">Hoàn Thành</option>
                                        }
                                        else
                                        {
                                            <option value="Hoàn Thành">Hoàn Thành</option>
                                        }
                                    </select>
                                    <button class="btn btn-sm btn-outline-primary" type="submit">Cập nhật</button>
                                </form>
                            </td>
                            <td>
                                @{ var a = o.Address; var addr = a!=null ? string.Join(", ", new[]{ a.AddressLine, a.Ward, a.District, a.City }.Where(s=>!string.IsNullOrWhiteSpace(s))) : ""; }
                                @addr
                            </td>
                            <td>@o.OrderDate.ToString("yyyy-MM-dd HH:mm")</td>
                            <td>
                                <a asp-controller="Checkout" asp-action="Index" class="btn btn-sm btn-outline-secondary" target="_blank">Xem</a>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>