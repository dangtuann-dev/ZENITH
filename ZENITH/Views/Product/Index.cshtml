@model ZENITH.ViewModels.ProductListViewModel
@using System.Globalization
@{
    ViewData["Title"] = "| Kết quả tìm kiếm";
}

<main class="product-page">
    <div class="container">
        <div class="product-container">
            <form id="product-filter-form" method="get" asp-controller="Product" asp-action="Index" class="mb-3" style="display:flex;gap:12px;flex-wrap:wrap">
                <input type="text" name="q" value="@Model.Query" class="form-control" placeholder="Tìm theo tên hoặc SKU" style="max-width:260px" />
                <select id="product-category" name="categoryId" class="form-control" style="max-width:220px">
                    <option value="">Danh mục</option>
                    @foreach (var c in (Model.Categories ?? new List<ZENITH.ViewModels.CategoryItem>()))
                    {
                        if (Model.CategoryId == c.Id)
                        {
                            <option value="@c.Id" selected="selected">@c.Name</option>
                        }
                        else
                        {
                            <option value="@c.Id">@c.Name</option>
                        }
                    }
                </select>
                <select id="product-sport" name="sportId" class="form-control" style="max-width:220px">
                    <option value="">Môn thể thao</option>
                    @foreach (var s in (Model.Sports ?? new List<ZENITH.ViewModels.SportItem>()))
                    {
                        if (Model.SportId == s.Id)
                        {
                            <option value="@s.Id" selected="selected">@s.Name</option>
                        }
                        else
                        {
                            <option value="@s.Id">@s.Name</option>
                        }
                    }
                </select>
                <select name="sort" class="form-control" style="max-width:200px">
                    <option value="">Sắp xếp</option>
                    @if (Model.Sort=="name_asc") { <option value="name_asc" selected="selected">Tên A→Z</option> } else { <option value="name_asc">Tên A→Z</option> }
                    @if (Model.Sort=="name_desc") { <option value="name_desc" selected="selected">Tên Z→A</option> } else { <option value="name_desc">Tên Z→A</option> }
                    @if (Model.Sort=="price_asc") { <option value="price_asc" selected="selected">Giá tăng dần</option> } else { <option value="price_asc">Giá tăng dần</option> }
                    @if (Model.Sort=="price_desc") { <option value="price_desc" selected="selected">Giá giảm dần</option> } else { <option value="price_desc">Giá giảm dần</option> }
                </select>
                <button class="btn btn-primary" type="submit">Lọc</button>
            </form>
        </div>

    <div class="product-container">
        <div class="row">
            <div class="col-12">
                <div style="display:flex;flex-direction:column;min-height:60vh;width:100%">
                    <div class="product-grid">
                        @if (Model.Products != null && Model.Products.Any())
                        {
                            @await Html.PartialAsync("_ProductCardList", Model.Products)
                        }
                        else
                        {
                            <p>Không có sản phẩm phù hợp.</p>
                        }
                    </div>
                    <div style="display:block;text-align:center;margin-top:auto;width:100%" class="mt-3">
                        @{
                            var prevPage = (Model.Page > 1) ? Model.Page - 1 : 1;
                            var nextPage = (Model.Page < Model.TotalPages) ? Model.Page + 1 : Model.TotalPages;
                        }
                        <div style="display:inline-flex;gap:8px;align-items:center;justify-content:center;padding-top:20px;">
                            <a class="btn btn-outline-secondary"
                               asp-controller="Product" asp-action="Index"
                               asp-route-q="@Model.Query" asp-route-categoryId="@Model.CategoryId" asp-route-sportId="@Model.SportId" asp-route-sort="@Model.Sort"
                               asp-route-page="@prevPage" asp-route-pageSize="@Model.PageSize">Trang trước</a>
                            <span>Trang @Model.Page/@Model.TotalPages</span>
                            <a class="btn btn-outline-secondary"
                               asp-controller="Product" asp-action="Index"
                               asp-route-q="@Model.Query" asp-route-categoryId="@Model.CategoryId" asp-route-sportId="@Model.SportId" asp-route-sort="@Model.Sort"
                               asp-route-page="@nextPage" asp-route-pageSize="@Model.PageSize">Trang sau</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>
    <script>
    (function(){
      var form = document.getElementById('product-filter-form');
      var sport = document.getElementById('product-sport');
      var cat = document.getElementById('product-category');
      function setOptions(items){
        while (cat.firstChild) cat.removeChild(cat.firstChild);
        var opt = document.createElement('option');
        opt.value = ''; opt.textContent = 'Danh mục';
        cat.appendChild(opt);
        (items||[]).forEach(function(i){
          var o = document.createElement('option');
          o.value = i.id; o.textContent = i.name; cat.appendChild(o);
        });
      }
      if (sport){
        sport.addEventListener('change', function(){
          var sid = sport.value || '';
          cat.value = '';
          var url = '/Product/CategoriesBySport' + (sid? ('?sportId='+encodeURIComponent(sid)) : '');
          fetch(url,{ credentials:'same-origin' }).then(function(r){ return r.json(); }).then(function(items){ setOptions(items); });
        });
      }
    })();
    </script>
</main>
