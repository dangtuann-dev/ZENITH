@using Microsoft.AspNetCore.Identity
@using ZENITH.Models
@using Microsoft.EntityFrameworkCore
@using System.Linq

@inject SignInManager<ApplicationUser> SignInManager
@inject UserManager<ApplicationUser> UserManager
@inject ZENITH.AppData.ApplicationDbContext DbContext


@if (SignInManager.IsSignedIn(User))
{
    var user = await UserManager.GetUserAsync(User);
    var userId = UserManager.GetUserId(User);
    var favoriteCount = DbContext.Favorites.AsNoTracking().Count(f => f.UserId == userId);

    string avatarUrl;
    var raw = user?.Avatar;
    if (string.IsNullOrWhiteSpace(raw))
    {
        avatarUrl = Url.Content("~/image/account/default-avatar.jpg");
    }
    else
    {
        var s = raw!.Trim().Replace("\\", "/");
        if (s.StartsWith("http://", System.StringComparison.OrdinalIgnoreCase) || s.StartsWith("https://", System.StringComparison.OrdinalIgnoreCase))
        {
            avatarUrl = s;
        }
        else if (s.StartsWith("~/"))
        {
            avatarUrl = Url.Content(s);
        }
        else if (s.StartsWith("/"))
        {
            avatarUrl = s;
        }
        else
        {
            var idx = s.ToLowerInvariant().IndexOf("wwwroot");
            if (idx >= 0)
            {
                var tail = s.Substring(idx + "wwwroot".Length);
                avatarUrl = Url.Content("~" + (tail.StartsWith("/") ? tail : "/" + tail));
            }
            else
            {
                avatarUrl = Url.Content("~/" + s.TrimStart('/'));
            }
        }
    }
    var displayName = string.IsNullOrWhiteSpace(user?.FullName) ? (user?.UserName ?? "") : user!.FullName;
    var displayAccount = user?.Email ?? user?.UserName ?? "";

    <style>
        .user-menu__top { position: relative; overflow: hidden; }
        .user-menu__bg { position: absolute; inset: 0; background-size: cover; background-position: center; filter: blur(14px); transform: scale(1.1); opacity: .6; }
        .user-menu__top .user-menu__avatar, .user-menu__top div { position: relative; z-index: 1; }
    </style>
    <div class="top-act">
        <a asp-controller="Favorites">
            <div class="top-act__group d-md-none top-act__group--single">
                <button class="top-act__btn">
                    <img src="/image/icons/search.svg" alt="" class="icon top-act__icon" />
                </button>
            </div>
        </a>


        <div class="top-act__group d-md-none">
            <div class="top-act__btn-wrap">
                <a asp-controller="Favorites" asp-action="Index" class="top-act__btn">
                    <img src="/image/icons/heart.svg" alt="" class="icon top-act__icon" />
                    <span id="js-favorite-count" class="top-act__title">@favoriteCount</span>
                </a>

                <!-- Dropdown Fav -->
                <div class="act-dropdown act-dropdown--favorites">
                    <div class="act-dropdown__inner">
                        <img src="/image/icons/arrow-up.png" alt="" class="act-dropdown__arrow" />
                        <div class="act-dropdown__top">
                            <h2 class="act-dropdown__title" id="js-favorite-count-text">Bạn có @favoriteCount mục yêu thích</h2>
                            <a asp-controller="Favorites" class="act-dropdown__view-all">Xem tất cả</a>
                        </div>
                        @{ 
                            var recentFavorites = DbContext.Favorites
                                .AsNoTracking()
                                .Where(f => f.UserId == userId)
                                .OrderByDescending(f => f.AddedAt)
                                .Include(f => f.ProductVariant)
                                    .ThenInclude(v => v.Product)
                                .ThenInclude(p => p.ProductImages)
                                .Take(3)
                                .ToList();
                            var culture = new System.Globalization.CultureInfo("vi-VN");
                        }
                        <div class="row row-cols-3 gx-2 act-dropdown__list" id="js-favorite-dropdown-list">
                            @if (recentFavorites.Any())
                            {
                                foreach (var f in recentFavorites)
                                {
                                    var product = f.ProductVariant.Product;
                                    var imgUrl = product.ProductImages.FirstOrDefault(i => i.IsPrimary)?.ImageUrl ?? "/image/default.avif";
                                    var displayPrice = f.ProductVariant.SalePrice ?? f.ProductVariant.Price;
                                    <div class="col">
                                        <article class="cart-preview-item">
                                            <div class="cart-preview-item__img-wrap">
                                                <a asp-controller="Product" asp-action="Detail" asp-route-id="@product.ProductId">
                                                    <img src="@Url.Content(imgUrl)"
                                                         alt="@product.ProductName"
                                                         class="cart-preview-item__thumb" />
                                                </a>
                                            </div>
                                            <h3 class="cart-preview-item__title">@product.ProductName</h3>
                                            <p class="cart-preview-item__price">@displayPrice.ToString("N0", culture) VND</p>
                                        </article>
                                    </div>
                                }
                            }
                            else
                            {
                                <div class="col">
                                    <p class="text-muted">Bạn chưa có bất kỳ sản phẩm yêu thích nào!</p>
                                </div>
                            }
                        </div>
                        <div class="act-dropdown__separate"></div>
                        <div class="act-dropdown__checkout">
                            <a asp-controller="Favorites"
                               class="btn btn--primary btn--rounded act-dropdown__checkout-btn">
                                Xem tất cả sản phẩm
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <div class="top-act__separate"></div>

            <div class="top-act__btn-wrap">
                @{ 
                    var cartItems = DbContext.CartItems
                        .AsNoTracking()
                        .Where(c => c.UserId == userId)
                        .OrderByDescending(c => c.UpdatedAt)
                        .Include(c => c.ProductVariant)
                            .ThenInclude(v => v.Product)
                                .ThenInclude(p => p.ProductImages)
                        .ToList();
                    var cartCount = cartItems.Sum(c => c.Quantity);
                    var subtotal = cartItems.Sum(c => (c.ProductVariant.SalePrice ?? c.ProductVariant.Price) * c.Quantity);
                    var shipping = cartItems.Count * 15000m;
                    var tax = 0m;
                    var total = subtotal + shipping + tax;
                    var culture2 = new System.Globalization.CultureInfo("vi-VN");
                    var recentCart = cartItems.Take(3).ToList();
                }
                <a asp-controller="Checkout" asp-action="Index" class="top-act__btn">
                    <img src="/image/icons/buy.svg" alt="" class="icon top-act__icon" />
                    <span class="top-act__title" id="js-header-cart-subtotal">@subtotal.ToString("N0", culture2) VND</span>
                </a>

                <div class="act-dropdown act-dropdown--cart">
                    <div class="act-dropdown__inner">
                        <img src="/image/icons/arrow-up.png" alt="" class="act-dropdown__arrow" />
                        <div class="act-dropdown__top">
                            <h2 class="act-dropdown__title" id="js-cart-title">Bạn có @cartCount sản phẩm</h2>
                            <a asp-controller="Checkout" asp-action="Index" class="act-dropdown__view-all">Xem tất cả</a>
                        </div>
                        <div class="row row-cols-3 gx-2 act-dropdown__list" id="js-cart-dropdown-list">
                            @if (recentCart.Any())
                            {
                                foreach (var ci in recentCart)
                                {
                                    var product = ci.ProductVariant.Product;
                                    var imgUrl = product.ProductImages.OrderByDescending(i => i.IsPrimary).ThenBy(i => i.DisplayOrder).Select(i => i.ImageUrl).FirstOrDefault() ?? "/image/default.avif";
                                    var priceEach = ci.ProductVariant.SalePrice ?? ci.ProductVariant.Price;
                                    <div class="col">
                                        <article class="cart-preview-item">
                                            <div class="cart-preview-item__img-wrap">
                                                <a asp-controller="Product" asp-action="Detail" asp-route-id="@product.ProductId">
                                                    <img src="@Url.Content(imgUrl)" alt="@product.ProductName" class="cart-preview-item__thumb" />
                                                </a>
                                            </div>
                                            <h3 class="cart-preview-item__title">@product.ProductName</h3>
                                            <p class="cart-preview-item__price">@priceEach.ToString("N0", culture2) VND x @ci.Quantity</p>
                                        </article>
                                    </div>
                                }
                            }
                            else
                            {
                                <div class="col">
                                    <p class="text-muted">Giỏ hàng của bạn đang trống</p>
                                </div>
                            }
                        </div>
                        <div class="act-dropdown__bottom">
                            <div class="act-dropdown__row">
                                <span class="act-dropdown__label">Tạm tính</span>
                                <span class="act-dropdown__value" id="js-cart-subtotal">@subtotal.ToString("N0", culture2) VND</span>
                            </div>
                            <div class="act-dropdown__row">
                                <span class="act-dropdown__label">Thuế</span>
                                <span class="act-dropdown__value">@tax.ToString("N0", culture2) VND</span>
                            </div>
                            <div class="act-dropdown__row">
                                <span class="act-dropdown__label">Vận chuyển</span>
                                <span class="act-dropdown__value" id="js-cart-shipping">@shipping.ToString("N0", culture2) VND</span>
                            </div>
                            <div class="act-dropdown__row act-dropdown__row--bold">
                                <span class="act-dropdown__label">Tổng</span>
                                <span class="act-dropdown__value" id="js-cart-total">@total.ToString("N0", culture2) VND</span>
                            </div>
                        </div>
                        <div class="act-dropdown__checkout">
                            <a asp-controller="Checkout" asp-action="Index" class="btn btn--primary btn--rounded act-dropdown__checkout-btn">Xem giỏ hàng</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="top-act__user">
            <a asp-controller="Profile" asp-action="Index" class="top-act__avatar-link" title="Trang hồ sơ">
                <img src="@avatarUrl" alt="Avatar" class="top-act__avatar" onerror="this.onerror=null;this.src='@Url.Content("~/image/account/default-avatar.jpg")';" />
            </a>

            <!-- Dropdown -->
            <div class="act-dropdown top-act__dropdown act-dropdown--profile">
                <div class="act-dropdown__inner user-menu">
                    <img src="/image/icons/arrow-up.png"
                         alt=""
                         class="act-dropdown__arrow top-act__dropdown-arrow" />

                    <div class="user-menu__top">
                        <div class="user-menu__bg" style="background-image:url('@avatarUrl')"></div>
                        <img src="@avatarUrl" alt="" class="user-menu__avatar" onerror="this.onerror=null;this.src='@Url.Content("~/image/account/default-avatar.jpg")';" />
                        <div>
                            <p class="user-menu__name">@displayName</p>
                            <p>@displayAccount</p>
                        </div>
                    </div>

                    <ul class="user-menu__list">
                        <li>
                            <a asp-controller="Profile" asp-action="Index" class="user-menu__link">Tài khoản</a>    
                        </li>
                        <li>
                            <a asp-controller="Favorites" asp-action="index" class="user-menu__link">Yêu thích</a>
                        </li>
                        <li class="user-menu__separate">
                            <a href="#" class="user-menu__link" id="switch-theme-btn">
                                <span>Nền tối</span>
                                <img src="/image/icons/sun.svg" alt="" class="icon user-menu__icon" />
                            </a>
                        </li>
                        <li>
                            <a href="#" class="user-menu__link">Cài đặt</a>
                        </li>
                        <li class="user-menu__separate">
                            <form class="form-inline" asp-area="Identity" asp-page="/Account/Logout" asp-route-returnUrl="@Url.Action("Index", "Home", new { area = "" })">
                                <button type="submit" class="user-menu__link">Đăng xuất</button>
                            </form>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
}
else
{
    <div class="top-act">
        <a id="login" asp-area="Identity" asp-page="/Account/Login" class="btn btn--text d-md-none">Đăng Nhập</a>
        <a id="register" asp-area="Identity" asp-page="/Account/Register" class="top-act__sign-up btn btn--primary">Đăng Ký</a>
    </div>
}
