@using Microsoft.AspNetCore.Identity
@using ZENITH.Models
@using Microsoft.EntityFrameworkCore
@using System.Linq

@inject SignInManager<ApplicationUser> SignInManager
@inject UserManager<ApplicationUser> UserManager
@inject ZENITH.AppData.ApplicationDbContext DbContext


@if (SignInManager.IsSignedIn(User))

{
    var userId = UserManager.GetUserId(User);
    var favoriteCount = DbContext.Favorites.AsNoTracking().Count(f => f.UserId == userId);
    <div class="top-act">
        <a asp-controller="Favorites">
            <div class="top-act__group d-md-none top-act__group--single">
                <button class="top-act__btn">
                    <img src="/image/icons/search.svg" alt="" class="icon top-act__icon" />
                </button>
            </div>
        </a>
     

        <div class="top-act__group d-md-none">
            <div class="top-act__btn-wrap">
                <a asp-controller="Favorites" asp-action="Index" class="top-act__btn">
                    <img src="/image/icons/heart.svg" alt="" class="icon top-act__icon" />
                    <span id="js-favorite-count" class="top-act__title">@favoriteCount</span>
                </a>

                <!-- Dropdown Fav -->
                <div class="act-dropdown act-dropdown--favorites">
                    <div class="act-dropdown__inner">
                        <img src="/image/icons/arrow-up.png" alt="" class="act-dropdown__arrow" />
                        <div class="act-dropdown__top">
                            <h2 class="act-dropdown__title" id="js-favorite-count-text">Bạn có @favoriteCount mục yêu thích</h2>
                            <a asp-controller="Favorites"  class="act-dropdown__view-all">Xem tất cả</a>
                        </div>
                        @{ 
                            // Lấy top 3 sản phẩm vừa được yêu thích của user hiện tại
                            var recentFavorites = DbContext.Favorites
                                .AsNoTracking()
                                .Where(f => f.UserId == userId)
                                .OrderByDescending(f => f.AddedAt)
                                .Include(f => f.ProductVariant)
                                    .ThenInclude(v => v.Product)
                                .ThenInclude(p => p.ProductImages)
                                .Take(3)
                                .ToList();
                            var culture = new System.Globalization.CultureInfo("vi-VN");
                        }
                        <div class="row row-cols-3 gx-2 act-dropdown__list" id="js-favorite-dropdown-list">
                            @if (recentFavorites.Any())
                            {
                                foreach (var f in recentFavorites)
                                {
                                    var product = f.ProductVariant.Product;
                                    var imgUrl = product.ProductImages.FirstOrDefault(i => i.IsPrimary)?.ImageUrl ?? "/image/default.avif";
                                    var displayPrice = f.ProductVariant.SalePrice ?? f.ProductVariant.Price;
                                    <div class="col">
                                        <article class="cart-preview-item">
                                            <div class="cart-preview-item__img-wrap">
                                                <a asp-controller="Product" asp-action="Detail" asp-route-id="@product.ProductId">
                                                    <img src="@Url.Content(imgUrl)"
                                                         alt="@product.ProductName"
                                                         class="cart-preview-item__thumb" />
                                                </a>
                                            </div>
                                            <h3 class="cart-preview-item__title">@product.ProductName</h3>
                                            <p class="cart-preview-item__price">@displayPrice.ToString("N0", culture) VND</p>
                                        </article>
                                    </div>
                                }
                            }
                            else
                            {
                                <div class="col">
                                    <p class="text-muted">Bạn chưa có bất kỳ sản phẩm yêu thích nào!</p>
                                </div>
                            }
                        </div>
                        <div class="act-dropdown__separate"></div>
                        <div class="act-dropdown__checkout">
                            <a asp-controller="Favorites"
                               class="btn btn--primary btn--rounded act-dropdown__checkout-btn">
                                Xem tất cả sản phẩm
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <div class="top-act__separate"></div>

            <div class="top-act__btn-wrap">
                <button class="top-act__btn">
                    <img src="/image/icons/buy.svg" alt="" class="icon top-act__icon" />
                    <span class="top-act__title">$65.42</span>
                </button>

                <!-- Dropdown cart -->
                <div class="act-dropdown act-dropdown--cart">
                    <div class="act-dropdown__inner">
                        <img src="/image/icons/arrow-up.png" alt="" class="act-dropdown__arrow" />
                        <div class="act-dropdown__top">
                            <h2 class="act-dropdown__title">You have 3 item(s)</h2>
                            <a href="./checkout.html" class="act-dropdown__view-all">See All</a>
                        </div>
                        <div class="row row-cols-3 gx-2 act-dropdown__list">
                            <!-- Cart preview item 1 -->
                            <div class="col">
                                <article class="cart-preview-item">
                                    <div class="cart-preview-item__img-wrap">
                                        <img src="/image/img/product/item-1.png"
                                             alt=""
                                             class="cart-preview-item__thumb" />
                                    </div>
                                    <h3 class="cart-preview-item__title">Lavazza Coffee Blends</h3>
                                    <p class="cart-preview-item__price">$329.00</p>
                                </article>
                            </div>

                            <!-- Cart preview item 2 -->
                            <div class="col">
                                <article class="cart-preview-item">
                                    <div class="cart-preview-item__img-wrap">
                                        <img src="/image/img/product/item-2.png"
                                             alt=""
                                             class="cart-preview-item__thumb" />
                                    </div>
                                    <h3 class="cart-preview-item__title">Coffee Beans Espresso</h3>
                                    <p class="cart-preview-item__price">$39.99</p>
                                </article>
                            </div>

                            <!-- Cart preview item 3 -->
                            <div class="col">
                                <article class="cart-preview-item">
                                    <div class="cart-preview-item__img-wrap">
                                        <img src="/image/img/product/item-3.png"
                                             alt=""
                                             class="cart-preview-item__thumb" />
                                    </div>
                                    <h3 class="cart-preview-item__title">Qualità Oro Mountain</h3>
                                    <p class="cart-preview-item__price">$47.00</p>
                                </article>
                            </div>
                        </div>
                        <div class="act-dropdown__bottom">
                            <div class="act-dropdown__row">
                                <span class="act-dropdown__label">Subtotal</span>
                                <span class="act-dropdown__value">$415.99</span>
                            </div>
                            <div class="act-dropdown__row">
                                <span class="act-dropdown__label">Texes</span>
                                <span class="act-dropdown__value">Free</span>
                            </div>
                            <div class="act-dropdown__row">
                                <span class="act-dropdown__label">Shipping</span>
                                <span class="act-dropdown__value">$10.00</span>
                            </div>
                            <div class="act-dropdown__row act-dropdown__row--bold">
                                <span class="act-dropdown__label">Total Price</span>
                                <span class="act-dropdown__value">$425.99</span>
                            </div>
                        </div>
                        <div class="act-dropdown__checkout">
                            <a href="./checkout.html"
                               class="btn btn--primary btn--rounded act-dropdown__checkout-btn">
                                Check Out All
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="top-act__user">
            <img src="/image/img/avatar.jpg" alt="" class="top-act__avatar" />

            <!-- Dropdown -->
            <div class="act-dropdown top-act__dropdown act-dropdown--profile">
                <div class="act-dropdown__inner user-menu">
                    <img src="/image/icons/arrow-up.png"
                         alt=""
                         class="act-dropdown__arrow top-act__dropdown-arrow" />

                    <div class="user-menu__top">
                        <img src="/image/img/avatar.jpg" alt="" class="user-menu__avatar" />
                        <div>
                            <p class="user-menu__name">John Smith</p>
                            <p>johnmith</p>
                        </div>
                    </div>

                    <ul class="user-menu__list">
                        <li>
                            <a href="./profile.html" class="user-menu__link">Profile</a>
                        </li>
                        <li>
                            <a href="./favourite.html" class="user-menu__link">Favourite list</a>
                        </li>
                        <li class="user-menu__separate">
                            <a href="#!" class="user-menu__link" id="switch-theme-btn">
                                <span>Dark mode</span>
                                <img src="/image/icons/sun.svg" alt="" class="icon user-menu__icon" />
                            </a>
                        </li>
                        <li>
                            <a href="#!" class="user-menu__link">Settings</a>
                        </li>
                        <li class="user-menu__separate">
                            <form class="form-inline" asp-area="Identity" asp-page="/Account/Logout" asp-route-returnUrl="@Url.Action("Index", "Home", new { area = "" })">
                                <button type="submit" class="user-menu__link">Logout</button>
                            </form>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
}
else
{
    
    <div class="top-act">
        <a id="login" asp-area="Identity" asp-page="/Account/Login" class="btn btn--text d-md-none">Đăng Nhập</a>
        <a id="register" asp-area="Identity" asp-page="/Account/Register" class="top-act__sign-up btn btn--primary">Đăng Ký</a>
    </div>
}

